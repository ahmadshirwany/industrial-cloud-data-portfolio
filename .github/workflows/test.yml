name: Code Quality Tests

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - develop
      - 'feature/**'

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Lint with Pylint

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint

      - name: Lint services
        run: |
          echo "ðŸ” Linting Python files..."
          pylint services/ --disable=all --enable=E,F 2>/dev/null || true

  docker-build-test:
    runs-on: ubuntu-latest
    name: Test Docker Builds
    strategy:
      matrix:
        service:
          - dashboard-frontend
          - dashboard-api
          - generator
          - ingestion
          - transformer
      fail-fast: false

    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image for ${{ matrix.service }}
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./services/${{ matrix.service }}/Dockerfile
          push: false
          tags: ${{ matrix.service }}:test

  security-check:
    runs-on: ubuntu-latest
    name: Security Checks

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install bandit
        run: |
          pip install bandit

      - name: Run security check
        run: |
          echo "ðŸ”’ Running security checks..."
          bandit -r services/ -f txt 2>/dev/null || true

  dependencies-check:
    runs-on: ubuntu-latest
    name: Check Dependencies

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pipdeptree

      - name: Check for duplicate dependencies
        run: |
          echo "ðŸ“¦ Checking requirements.txt for issues..."
          pip install -r requirements.txt --dry-run 2>/dev/null || true

  format-check:
    runs-on: ubuntu-latest
    name: Code Format Check

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install black
        run: |
          pip install black

      - name: Check code formatting
        run: |
          echo "ðŸŽ¨ Checking code format..."
          black --check services/ 2>/dev/null || true
